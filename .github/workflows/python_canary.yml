name: Python Canary Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov mypy mecab-python3 unidic
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Download UniDic dictionary
      run: |
        python -m unidic download

    - name: Run tests with unittest
      run: |
        python -m unittest discover -s tests-py -p 'test_*.py' -v

    - name: Validate Tatoeba sentences
      run: |
        echo "Validating all 195,143 Japanese sentences from Tatoeba corpus..."
        python validate_mappings.py all
      continue-on-error: false

    - name: Run tests with pytest
      run: |
        python -m pytest tests-py/ -v --cov=kotogram --cov-report=xml --cov-report=term
      continue-on-error: false

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      continue-on-error: true

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy pylint bandit safety

    - name: Check code formatting with black
      run: |
        echo "Checking code formatting..."
        black --check --diff .
      continue-on-error: true

    - name: Check import sorting with isort
      run: |
        echo "Checking import order..."
        isort --check-only --diff .
      continue-on-error: true

    - name: Lint with flake8
      run: |
        echo "Running flake8 linter..."
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
      continue-on-error: true

    - name: Lint with pylint
      run: |
        echo "Running pylint for code quality..."
        pylint kotogram/ --fail-under=8.0 --output-format=colorized || echo "⚠️  Pylint score below 8.0 (non-blocking)"
      continue-on-error: true

    - name: Type check with mypy
      run: |
        echo "Running mypy type checker..."
        # Check the main package
        mypy kotogram/ --ignore-missing-imports --strict
        # Check test files (informational only)
        mypy tests-py/ --ignore-missing-imports || echo "Test files have type issues (non-blocking)"
      continue-on-error: false

    - name: Security check with bandit
      run: |
        echo "Running security analysis with bandit..."
        bandit -r kotogram/ -f screen || echo "⚠️  Security issues found (review recommended)"
      continue-on-error: true

    - name: Check dependencies for vulnerabilities
      run: |
        echo "Checking dependencies for known vulnerabilities..."
        # Check if there are any dependencies first
        if [ -f requirements.txt ]; then
          safety check --file requirements.txt || echo "⚠️  Vulnerable dependencies found (review recommended)"
        else
          echo "No requirements.txt found, skipping dependency vulnerability check"
        fi
      continue-on-error: true

    - name: Check for common issues
      run: |
        echo "Checking for common issues..."

        # Check for print statements in production code
        echo "Checking for print() statements..."
        if grep -r "print(" kotogram/ --include="*.py" | grep -v "__pycache__"; then
          echo "⚠️  Warning: Found print() statements in production code. Consider using logging instead."
        else
          echo "✅ No print() statements found"
        fi

        # Check for TODO/FIXME comments
        echo ""
        echo "Checking for TODO/FIXME comments..."
        if grep -rn "TODO\|FIXME\|XXX\|HACK" kotogram/ --include="*.py" | grep -v "__pycache__"; then
          echo "⚠️  Found TODO/FIXME comments (review recommended)"
        else
          echo "✅ No TODO/FIXME comments found"
        fi

        # Check README exists and has content
        echo ""
        echo "Validating README..."
        if [ ! -f README.md ]; then
          echo "❌ ERROR: README.md is missing!"
          exit 1
        elif [ ! -s README.md ]; then
          echo "❌ ERROR: README.md is empty!"
          exit 1
        else
          echo "✅ README.md exists and has content"
        fi

        # Check LICENSE exists
        echo ""
        echo "Validating LICENSE..."
        if [ ! -f LICENSE ]; then
          echo "⚠️  Warning: LICENSE file is missing"
        else
          echo "✅ LICENSE file exists"
        fi
      continue-on-error: true

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel

    - name: Build package
      run: |
        python -m build

    - name: Validate package contents
      run: |
        echo "Checking Python package for TypeScript contamination..."

        # Extract the wheel to inspect contents
        WHEEL_FILE=$(ls dist/*.whl)
        unzip -l "$WHEEL_FILE" > /tmp/wheel_contents.txt

        # Check for TypeScript/Node.js files that shouldn't be in Python package
        if grep -E '\.(ts|js|tsx|jsx|mjs)$' /tmp/wheel_contents.txt; then
          echo "❌ ERROR: Found TypeScript/JavaScript files in Python package!"
          echo "The following files should not be in the Python wheel:"
          grep -E '\.(ts|js|tsx|jsx|mjs)$' /tmp/wheel_contents.txt
          exit 1
        fi

        # Check for node_modules or TypeScript config files
        if grep -E '(node_modules|package\.json|tsconfig\.json|package-lock\.json)' /tmp/wheel_contents.txt; then
          echo "❌ ERROR: Found Node.js/TypeScript configuration files in Python package!"
          grep -E '(node_modules|package\.json|tsconfig\.json|package-lock\.json)' /tmp/wheel_contents.txt
          exit 1
        fi

        # Check for TypeScript test files
        if grep -E 'tests-ts/' /tmp/wheel_contents.txt; then
          echo "❌ ERROR: Found TypeScript test files in Python package!"
          grep -E 'tests-ts/' /tmp/wheel_contents.txt
          exit 1
        fi

        echo "✅ Python package is clean - no TypeScript files found"
        echo ""
        echo "Package contents:"
        cat /tmp/wheel_contents.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  canary-report:
    name: Canary Status Report
    runs-on: ubuntu-latest
    needs: [test, lint, build]
    if: always()

    steps:
    - name: Check job results
      run: |
        echo "Test Status: ${{ needs.test.result }}"
        echo "Lint Status: ${{ needs.lint.result }}"
        echo "Build Status: ${{ needs.build.result }}"

        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "❌ Tests failed"
          exit 1
        elif [ "${{ needs.build.result }}" != "success" ]; then
          echo "❌ Build failed"
          exit 1
        else
          echo "✅ Canary build successful"
        fi
