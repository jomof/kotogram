#!/usr/bin/env python3
"""Command-line tool for working with kotograms."""

import argparse
import sys
from typing import Optional


def get_parser(parser_type: str):
    """Get the appropriate parser instance."""
    if parser_type == "mecab":
        from kotogram.mecab_japanese_parser import MecabJapaneseParser
        return MecabJapaneseParser()
    else:
        from kotogram.sudachi_japanese_parser import SudachiJapaneseParser
        return SudachiJapaneseParser()


def cmd_parse(args) -> int:
    """Parse Japanese text to kotogram format."""
    parser = get_parser(args.parser)
    text = args.text

    if text == "-":
        text = sys.stdin.read().strip()

    kotogram = parser.japanese_to_kotogram(text)
    print(kotogram)
    return 0


def cmd_raw(args) -> int:
    """Show raw parser output for inspection."""
    text = args.text

    if text == "-":
        text = sys.stdin.read().strip()

    # Print original sentence
    print(f"Input: {text}")
    print()

    if args.parser == "mecab":
        import MeCab
        import unidic
        import os

        dicdir = unidic.DICDIR
        if not os.path.isdir(dicdir):
            unidic_path = os.path.dirname(unidic.__file__)
            dicdir = os.path.join(unidic_path, "dicdir")

        tagger = MeCab.Tagger('-d "{}"'.format(dicdir))
        raw_output = tagger.parse(text)
        print("MeCab raw output:")
        print(raw_output)
    else:
        from sudachipy import dictionary

        dict_obj = dictionary.Dictionary(dict='full')
        tokenizer = dict_obj.create()
        tokens = tokenizer.tokenize(text)

        print("Sudachi raw output:")
        for token in tokens:
            print(f"Surface: {token.surface()}")
            print(f"  POS: {token.part_of_speech()}")
            print(f"  Dictionary form: {token.dictionary_form()}")
            print(f"  Reading form: {token.reading_form()}")
            print(f"  Normalized form: {token.normalized_form()}")
            print()

    return 0


def main() -> int:
    parser = argparse.ArgumentParser(
        prog="kotogram",
        description="Command-line tool for working with kotograms",
    )

    subparsers = parser.add_subparsers(dest="command", required=True)

    # parse command
    parse_parser = subparsers.add_parser(
        "parse",
        help="Parse Japanese text to kotogram format",
    )
    parse_parser.add_argument(
        "text",
        help="Japanese text to parse (use '-' to read from stdin)",
    )
    parser_group = parse_parser.add_mutually_exclusive_group()
    parser_group.add_argument(
        "-m", "--mecab",
        action="store_const",
        const="mecab",
        dest="parser",
        help="Use MeCab parser",
    )
    parser_group.add_argument(
        "-s", "--sudachi",
        action="store_const",
        const="sudachi",
        dest="parser",
        help="Use Sudachi parser (default)",
    )
    parse_parser.set_defaults(parser="sudachi", func=cmd_parse)

    # raw command
    raw_parser = subparsers.add_parser(
        "raw",
        help="Show raw parser output for inspection",
    )
    raw_parser.add_argument(
        "text",
        help="Japanese text to parse (use '-' to read from stdin)",
    )
    raw_parser_group = raw_parser.add_mutually_exclusive_group()
    raw_parser_group.add_argument(
        "-m", "--mecab",
        action="store_const",
        const="mecab",
        dest="parser",
        help="Use MeCab parser",
    )
    raw_parser_group.add_argument(
        "-s", "--sudachi",
        action="store_const",
        const="sudachi",
        dest="parser",
        help="Use Sudachi parser (default)",
    )
    raw_parser.set_defaults(parser="sudachi", func=cmd_raw)

    args = parser.parse_args()

    try:
        return args.func(args)
    except KeyboardInterrupt:
        return 130
    except BrokenPipeError:
        return 0
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
