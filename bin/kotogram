#!/usr/bin/env python3
"""Command-line tool for working with kotograms."""

import argparse
import sys


def get_parser():
    """Get the Sudachi parser instance."""
    from kotogram.sudachi_japanese_parser import SudachiJapaneseParser
    return SudachiJapaneseParser()


def cmd_parse(args) -> int:
    """Parse Japanese text to kotogram format."""
    parser = get_parser()
    text = args.text

    if text == "-":
        text = sys.stdin.read().strip()

    kotogram = parser.japanese_to_kotogram(text)
    print(kotogram)
    return 0


def cmd_raw(args) -> int:
    """Show raw parser output for inspection."""
    text = args.text

    if text == "-":
        text = sys.stdin.read().strip()

    # Print original sentence
    print(f"Input: {text}")
    print()

    from sudachipy import dictionary

    dict_obj = dictionary.Dictionary(dict='full')
    tokenizer = dict_obj.create()
    tokens = tokenizer.tokenize(text)

    print("Sudachi raw output:")
    for token in tokens:
        print(f"Surface: {token.surface()}")
        print(f"  POS: {token.part_of_speech()}")
        print(f"  Dictionary form: {token.dictionary_form()}")
        print(f"  Reading form: {token.reading_form()}")
        print(f"  Normalized form: {token.normalized_form()}")
        print()

    return 0


def main() -> int:
    parser = argparse.ArgumentParser(
        prog="kotogram",
        description="Command-line tool for working with kotograms",
    )

    subparsers = parser.add_subparsers(dest="command", required=True)

    # parse command
    parse_parser = subparsers.add_parser(
        "parse",
        help="Parse Japanese text to kotogram format",
    )
    parse_parser.add_argument(
        "text",
        help="Japanese text to parse (use '-' to read from stdin)",
    )
    parse_parser.set_defaults(func=cmd_parse)

    # raw command
    raw_parser = subparsers.add_parser(
        "raw",
        help="Show raw parser output for inspection",
    )
    raw_parser.add_argument(
        "text",
        help="Japanese text to parse (use '-' to read from stdin)",
    )
    raw_parser.set_defaults(func=cmd_raw)

    args = parser.parse_args()

    try:
        return args.func(args)
    except KeyboardInterrupt:
        return 130
    except BrokenPipeError:
        return 0
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
